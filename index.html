<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="main.css">
</head>
<body>
	<div class="wrap" onclick="openBox()">
		<div class="solid" id="box">
		  <div class="side"></div>
		  <div class="side"></div>
		  <div class="side"></div>
		  <div class="side"></div>
		  <div class="side"></div>
		  <div class="side"></div>
		  <div class="side"></div>
		  <div class="side"></div>
		</div>
	</div>
	
	<script>
		var Recording = function(cb){
		    var recorder = null;
		    var recording = true;
		    var audioInput = null;
		    var volume = null;
		    var audioContext = null;
		    var callback = cb;
		    navigator.getUserMedia = navigator.getUserMedia    || navigator.webkitGetUserMedia ||
	                               navigator.mozGetUserMedia || navigator.msGetUserMedia;
	    	if(navigator.getUserMedia){
	        	navigator.getUserMedia({audio:true},
		        function(e){ //success
		            var AudioContext = window.AudioContext || window.webkitAudioContext;
		            audioContext = new AudioContext();
		            volume = audioContext.createGain(); // creates a gain node
		            audioInput = audioContext.createMediaStreamSource(e); // creates an audio node from the mic stream
		            audioInput.connect(volume);// connect the stream to the gain node
		            recorder = audioContext.createScriptProcessor(2048, 1, 1);
		            recorder.onaudioprocess = function(e){
		                if(!recording) return;
		                var left = e.inputBuffer.getChannelData(0);
		                //var right = e.inputBuffer.getChannelData(1);
		                callback(new Float32Array(left));
		            };
		            volume.connect(recorder);// connect the recorder
		            recorder.connect(audioContext.destination);
		        },
		        function(e){ //failure
		            alert('Error capturing audio.');
		        });
	        } else {
	        alert('getUserMedia not supported in this browser.');
	      	}
	    };
	    var lastClap = (new Date()).getTime();
	    function detectClap(data){
		    var t = (new Date()).getTime();
		    if(t - lastClap < 200) return false; // TWEAK HERE
		    var zeroCrossings = 0, highAmp = 0;
		    for(var i = 1; i < data.length; i++){
		    	if(Math.abs(data[i]) > 0.25) highAmp++; // TWEAK HERE
		    	if(data[i] > 0 && data[i-1] < 0 || data[i] < 0 && data[i-1] > 0) zeroCrossings++;
		    }
		    if(highAmp > 20 && zeroCrossings > 30){ // TWEAK HERE
		    	//console.log(highAmp+' / '+zeroCrossings);
		    	lastClap = t;
		        return true;
		    }
		    return false;
	    }
	    var rec = new Recording(function(data){
	    	if(detectClap(data)){
	    		console.log('clap!');
	        	openBox();
	      	}
	    });

		function openBox() {
			var x = document.getElementsByClassName("side");
			x[0].style.transform = "translateX(-2400px) translateY(4400px)";
			x[1].style.transform = "translateZ(3300px)";
			x[2].style.transform = "translateZ(1200px)";
			x[3].style.transform = "translateZ(7100px)";
			x[4].style.transform = "translateZ(-2100px) translateY(2400px)";
			x[5].style.transform = "translateZ(6200px) translateY(4800px)";
			x[6].style.transform = "translateZ(-3300px) translateY(4200px)";
			x[7].style.transform = "translateZ(-2400px) translateY(4500px)";
			setTimeout(function(){ removeElementsByClass("solid"); }, 1000);
		}

		function removeElementsByClass(className){
		    var elements = document.getElementsByClassName(className);
		    while(elements.length > 0){
		        elements[0].parentNode.removeChild(elements[0]);
		    }
		}
	</script>
</body>
</html>